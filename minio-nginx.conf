# Конфигурация Nginx для проксирования MinIO
# Добавьте этот блок в ваш nginx.conf на сервере

# Опционально: Кеширование для MinIO assets
proxy_cache_path /var/cache/nginx/minio levels=1:2 keys_zone=minio_cache:10m max_size=1g inactive=30d use_temp_path=off;

server {
    listen 80;
    listen [::]:80;
    server_name nightfall-arena.ru;

    # ... остальные location блоки ...

    # Проксирование запросов к MinIO для медиа-файлов
    location /minio/ {
        # Проксируем на MinIO сервер
        proxy_pass http://localhost:9000/elbrus-arena-assets/;

        # Заголовки для прокси
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Увеличиваем таймауты для больших файлов
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        send_timeout 300s;

        # Буферизация для оптимизации передачи
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;

        # CORS headers (если MinIO CORS не работает)
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        add_header Access-Control-Allow-Headers "*" always;

        # Кеширование на стороне клиента (30 дней для immutable assets)
        expires 30d;
        add_header Cache-Control "public, immutable";

        # Кеширование на стороне nginx (опционально)
        proxy_cache minio_cache;
        proxy_cache_valid 200 30d;
        proxy_cache_valid 404 1m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;
        proxy_cache_lock on;
        add_header X-Cache-Status $upstream_cache_status;

        # Обработка OPTIONS для CORS preflight
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
            add_header Access-Control-Allow-Headers *;
            add_header Access-Control-Max-Age 3600;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
    }

    # Прямой доступ к MinIO Console (опционально, для администрирования)
    # ВАЖНО: Защитите basic auth или VPN!
    location /minio-admin/ {
        proxy_pass http://localhost:9001/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket поддержка для MinIO Console
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Basic Auth для защиты (настройте!)
        # auth_basic "MinIO Admin";
        # auth_basic_user_file /etc/nginx/.htpasswd;
    }
}

# HTTPS конфигурация (рекомендуется для production)
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name nightfall-arena.ru;

    # SSL сертификаты (настройте через certbot)
    # ssl_certificate /etc/letsencrypt/live/nightfall-arena.ru/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/nightfall-arena.ru/privkey.pem;

    # ... скопируйте все location блоки из HTTP версии ...
}

# Редирект HTTP -> HTTPS (после настройки SSL)
# server {
#     listen 80;
#     listen [::]:80;
#     server_name nightfall-arena.ru;
#     return 301 https://$host$request_uri;
# }
