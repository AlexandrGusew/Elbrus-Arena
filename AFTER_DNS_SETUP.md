# Продолжение настройки Stage после добавления DNS

## Текущий статус

Вы остановились на добавлении A записи в DNS. После того как DNS запись будет добавлена, выполните следующие шаги.

## Шаг 1: Проверка DNS записи

Убедитесь что DNS запись добавлена:

- **Имя:** `stage`
- **Тип:** `A`
- **Значение:** `178.72.152.120`
- **TTL:** `3600` (или по умолчанию)

Проверьте DNS запись:

```bash
# На локальной машине или stage сервере
dig stage.nightfall-arena.ru +short
# Должен вернуть: 178.72.152.120

# Или через веб-интерфейс:
# https://www.whatsmydns.net/#A/stage.nightfall-arena.ru
```

**Важно:** Подождите 5-15 минут после добавления DNS записи для распространения.

## Шаг 2: Автоматическое продолжение настройки

После того как DNS запись настроена, запустите скрипт для автоматической настройки:

### Вариант A: С локальной машины

```bash
# Сделайте скрипт исполняемым
chmod +x scripts/continue-after-dns.sh

# Запустите скрипт
./scripts/continue-after-dns.sh
```

Скрипт автоматически:
- ✅ Проверит DNS запись
- ✅ Установит недостающие зависимости (Docker, Nginx, Certbot)
- ✅ Клонирует/обновит проект
- ✅ Создаст базовые .env файлы (если нужно)
- ✅ Настроит Nginx
- ✅ Получит SSL сертификат
- ✅ Запустит приложение

### Вариант B: На stage сервере напрямую

```bash
# Подключитесь к stage серверу
ssh root@178.72.152.120

# Скопируйте скрипт на сервер (с локальной машины)
scp scripts/continue-after-dns.sh root@178.72.152.120:/root/

# На сервере
chmod +x /root/continue-after-dns.sh
/root/continue-after-dns.sh
```

## Шаг 3: Ручная настройка (если автоматическая не подходит)

Если предпочитаете настраивать вручную, следуйте инструкциям в `QUICK_START_STAGE.md` начиная с шага 4 (после настройки DNS).

## Что делает скрипт continue-after-dns.sh

1. **Проверка DNS** - убеждается что DNS запись настроена
2. **Установка зависимостей** - Docker, Docker Compose, Nginx, Certbot
3. **Клонирование проекта** - если проект еще не клонирован
4. **Настройка .env** - создает базовые .env файлы (⚠️ проверьте секреты!)
5. **Настройка Nginx** - создает конфигурацию для stage.nightfall-arena.ru
6. **SSL сертификат** - получает сертификат от Let's Encrypt
7. **Инициализация БД** - запускает миграции Prisma
8. **Сборка и запуск** - собирает Docker образы и запускает контейнеры

## После завершения

После успешного выполнения скрипта:

1. **Проверьте доступность:**
   ```bash
   curl -I https://stage.nightfall-arena.ru
   ```

2. **Проверьте логи:**
   ```bash
   ssh root@178.72.152.120 'cd /var/www/app && docker compose logs -f'
   ```

3. **Откройте в браузере:**
   - https://stage.nightfall-arena.ru

## Важные замечания

⚠️ **JWT_SECRET:** Скрипт создаст случайный JWT_SECRET, но лучше использовать тот же что на продакшн (если нужно единое авторизование) или скопировать из продакшн конфигурации.

⚠️ **База данных:** Stage использует ту же БД что и продакшн. Будьте осторожны с тестовыми данными!

⚠️ **MinIO:** Stage использует то же хранилище что и продакшн. Медиа файлы общие.

## Устранение проблем

### DNS не распространился

Подождите еще 10-15 минут и проверьте снова:
```bash
dig stage.nightfall-arena.ru +short
```

### SSL сертификат не получается

Убедитесь что:
- DNS запись настроена и распространилась
- Порт 80 открыт на сервере
- Nginx запущен и слушает порт 80

Попробуйте получить сертификат вручную:
```bash
ssh root@178.72.152.120
certbot certonly --standalone -d stage.nightfall-arena.ru
```

### Контейнеры не запускаются

Проверьте логи:
```bash
ssh root@178.72.152.120 'cd /var/www/app && docker compose logs'
```

Проверьте .env файлы:
```bash
ssh root@178.72.152.120 'cd /var/www/app && cat .env && cat backend/.env'
```

---

**Готово!** После выполнения всех шагов stage окружение будет доступно по адресу: **https://stage.nightfall-arena.ru**


