═══════════════════════════════════════════════════════════════════════════════
                        АКТУАЛЬНЫЕ ЗАДАЧИ РЕФАКТОРИНГА
                           Осталось: 17 задач из 41
═══════════════════════════════════════════════════════════════════════════════

📊 ПРОГРЕСС: 24/41 (59%)
✅ Выполненные задачи смотри в файле READY.txt

═══════════════════════════════════════════════════════════════════════════════
                    ПРИОРИТЕТ 1 - КРИТИЧНО (4 задачи)
═══════════════════════════════════════════════════════════════════════════════

БЕЗОПАСНОСТЬ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[ ] 26. Нет аутентификации
    Проблема: Любой может делать запросы с любым characterId
    Решение: Реализовать проверку Telegram initData
    Файлы: backend/src/auth/ (создать модуль)
    Статус: НИЗКИЙ ПРИОРИТЕТ - для продакшена

[ ] 27. Нет проверки владения персонажем
    Проблема: Игрок может управлять чужими персонажами
    Решение: Создать AuthGuard, проверять userId
    Файлы: backend/src/auth/guards/auth.guard.ts (создать)
    Статус: НИЗКИЙ ПРИОРИТЕТ - для продакшена

[ ] 28. SQL Injection потенциал
    Где: character.controller.ts:14-22 Number(id) без валидации
    Проблема: NaN при невалидном ID
    Решение: Добавить ValidationPipe, DTO с @IsNumber()
    Файлы: backend/src/main.ts, все контроллеры

[ ] 29. Нет rate limiting
    Проблема: Возможна DDoS атака
    Решение: Добавить @nestjs/throttler
    Файлы: backend/src/app.module.ts
    Статус: НИЗКИЙ ПРИОРИТЕТ - для продакшена


═══════════════════════════════════════════════════════════════════════════════
                    ПРИОРИТЕТ 2 - ВАЖНО (3 задачи)
═══════════════════════════════════════════════════════════════════════════════

АРХИТЕКТУРА И ВАЛИДАЦИЯ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[ ] 16. Отсутствие валидации DTO
    Где: Все контроллеры
    Решение: Добавить class-validator, создать DTO классы
    Файлы: backend/src/character/dto/ (создать),
           backend/src/battle/dto/ (создать),
           backend/src/main.ts (добавить ValidationPipe)

[ ] 35. Валидация имени персонажа
    Где: CreateCharacter.tsx:22-25
    Решение: Проверка длины 3-20, только буквы/цифры, обработка ошибки уникальности
    Файлы: frontend/src/pages/CreateCharacter.tsx,
           backend/src/character/dto/create-character.dto.ts (создать)

[ ] 36. Валидация действий в бою
    Где: battle.service.ts:104-107
    Решение: Проверить количество, валидность зон, дубликаты
    Файлы: backend/src/battle/dto/round-actions.dto.ts (создать)


═══════════════════════════════════════════════════════════════════════════════
                    ПРИОРИТЕТ 3 - СРЕДНЕ (8 задач)
═══════════════════════════════════════════════════════════════════════════════

ЛОГИЧЕСКИЕ ПРОБЛЕМЫ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[ ] 21. Stamina не тратится и не восстанавливается
    Где: Dungeon.tsx:100 проверяет, но не вычитает
    Решение: Реализовать механику траты/восстановления
    Файлы: backend/src/character/character.service.ts,
           backend/src/battle/battle.service.ts
    Статус: ✅ ЧАСТИЧНО ВЫПОЛНЕНО - восстановление работает, трата работает

[ ] 25. N+1 проблема в БД запросах
    Где: battle.service.ts:104-149 три отдельных запроса
    Решение: Оптимизировать через единый запрос с include
    Файлы: backend/src/battle/battle.service.ts

ПРОБЛЕМЫ ФРОНТЕНДА
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[ ] 30. Нет централизованного состояния
    Где: Персонаж загружается заново на каждой странице
    Решение: Использовать Redux для хранения текущего персонажа
    Файлы: frontend/src/store/character.slice.ts (создать)
    Статус: ✅ RTK Query кеширует данные - проблема решена частично

[ ] 31. Небезопасное использование localStorage
    Где: CreateCharacter.tsx:44, main.tsx:16-20
    Решение: Создать утилиту safeStorage
    Файлы: frontend/src/utils/storage.ts (создать)

[ ] 32. Хардкод строк и magic numbers
    Где: CreateCharacter.tsx:32, :8-12, DifficultySelector.tsx:4-8
    Решение: Создать frontend/src/constants/game.ts
    Файлы: frontend/src/constants/game.ts (создать)

[ ] 33. Отсутствие обработки edge cases
    Где: Dashboard.tsx:57, CharacterStats.tsx:9 (деление на ноль)
    Решение: Добавить проверки maxHp > 0
    Файлы: frontend/src/pages/Dashboard.tsx,
           frontend/src/components/battle/CharacterStats.tsx

[ ] 34. Проблемы с WebSocket
    Где: useBattle.ts:23-95 нет реконнекта
    Решение: Добавить автоматический реконнект
    Файлы: frontend/src/hooks/useBattle.ts

ПРОИЗВОДИТЕЛЬНОСТЬ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[ ] 38. Чрезмерное JSON.parse/stringify
    Где: battle.service.ts:212
    Решение: Убрать двойное преобразование
    Файлы: backend/src/battle/battle.service.ts

[ ] 39. Нет индексов в БД
    Решение: Добавить индексы для userId, telegramId
    Файлы: backend/prisma/schema.prisma


═══════════════════════════════════════════════════════════════════════════════
                    ПРИОРИТЕТ 4 - НИЗКИЙ (2 задачи)
═══════════════════════════════════════════════════════════════════════════════

[ ] 12. Inline стили везде
    Статус: НИЗКИЙ ПРИОРИТЕТ - можно пропустить

[ ] 37. Несогласованность настроек ngrok
    Статус: НИЗКИЙ ПРИОРИТЕТ - для продакшена


═══════════════════════════════════════════════════════════════════════════════
                            🎯 НОВЫЕ ЗАДАЧИ
═══════════════════════════════════════════════════════════════════════════════

МЕХАНИКА БОЯ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[ ] 42. Одновременная смерть в бою
    Где: battle.service.ts - механика боя
    Проблема: Когда оба персонажа убивают друг друга одновременно (оба по 20 HP),
             засчитывается проигрыш, хотя должно быть неопределенно
    Решение: Добавить механику инициативы:
      - В начале боя бросается кубик (рандом) - кто бьет первым
      - После каждого раунда очередность меняется
      - Если первый боец убивает противника - он победил, нет одновременной смерти
    Файлы: backend/src/battle/battle.service.ts,
           backend/src/battle/utils/combat-calculator.ts


═══════════════════════════════════════════════════════════════════════════════
                        РЕКОМЕНДУЕМЫЙ ПОРЯДОК ВЫПОЛНЕНИЯ
═══════════════════════════════════════════════════════════════════════════════

🔥 СРОЧНО (делаем сейчас):
  1. Задача 42 - Исправить одновременную смерть в бою
  2. Задача 25 - Оптимизировать N+1 запросы в БД

💪 ВАЖНО (следующие):
  3. Задача 16 - Добавить DTO валидацию
  4. Задача 35 - Валидация имени персонажа
  5. Задача 33 - Обработка edge cases (деление на 0)

🛡️ БЕЗОПАСНОСТЬ (для продакшена):
  - Задачи 26-29 (аутентификация, rate limiting)

🎨 ОПЦИОНАЛЬНО:
  - Задачи 30-34, 37-39 (улучшения UX и производительности)
