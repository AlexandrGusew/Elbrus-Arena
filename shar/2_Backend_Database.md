# Backend + База данных - Dark Fantasy Game (Telegram Mini App)

## 1. Технологический стек

### Backend
- **Runtime**: Node.js 20 LTS
- **Framework**: NestJS
- **WebSocket**: Socket.io
- **ORM**: Prisma
- **Authentication**: JWT + Telegram Web App validation

### Database & Cache
- **Primary DB**: PostgreSQL 15

### Infrastructure
- **Container**: Docker + Docker Compose
- **CI/CD**: GitHub Actions
- **Monitoring**: Prometheus + Grafana
- **Logging**: Winston
- **Error Tracking**: Sentry

## 2. Архитектура Backend

### 2.1 Модульная структура
- Auth Module - авторизация через Telegram
- Character Module - управление персонажами
- Battle Module - боевая система
- Inventory Module - инвентарь и экипировка
- Matchmaking Module - поиск противников
- Dungeon Module - PvE данжи

MVP
- Blacksmith Module - заточка предметов
- Telegram Module - интеграция с ботом

### 2.2 Общие сервисы
- WebSocket Gateway - реальное время для боев
- Queue Service - обработка отложенных задач
- Cache Service - кэширование данных
- Logger Service - логирование

## 3. База данных - что нужно хранить

### 3.1 Пользователи и персонажи
**Нужно хранить:**
- Данные пользователей из Telegram (ID, имя, язык)
- Персонажей (класс, уровень, характеристики)
- Прогресс и статистику игроков
- Баланс ресурсов (золото, стамина)
- PvP рейтинг и статистику побед/поражений

### 3.2 Игровые предметы
**Нужно хранить:**
- Справочник всех предметов игры
- Инвентарь каждого игрока
- Экипированные предметы
- Уровень заточки предметов
- Требования для экипировки

### 3.3 PvE контент
**Нужно хранить:**
- Данжи и их сложность
- Монстров и их характеристики
- Привязку монстров к данжам
- Таблицы дропа предметов
- Награды за прохождение

### 3.4 Боевая система
**Нужно хранить:**
- Историю всех боев
- Логи каждого раунда
- Использованные способности и зелья
- Нанесенный урон и результаты
- Полученные награды

### 3.5 Экономика
**Нужно хранить:**
- Магазин и цены
- Историю покупок
- Историю заточек у кузнеца
- Транзакции золота

### 3.6 Социальные функции
**Нужно хранить:**
- Таблицу лидеров
- Будущее: гильдии, турниры, торговлю

## 5. API Endpoints (основные группы)

### 5.1 Авторизация
- Вход через Telegram Web App
- Обновление токенов
- Выход

### 5.2 Управление персонажем
- Создание персонажа
- Просмотр статистики
- Распределение очков
- Сброс характеристик

### 5.3 PvE бои
- Список данжей
- Вход в данж
- Действия в бою
- Использование способностей/зелий
- Получение наград

### 5.4 PvP бои
- Поиск противника
- Отмена поиска
- Действия в бою
- Таблица лидеров

### 5.5 Инвентарь
- Просмотр инвентаря
- Экипировка предметов
- Снятие экипировки
- Продажа предметов

### 5.6 Магазин
- Список товаров
- Покупка предметов

### 5.7 Кузнец
- Заточка предметов
- Расчет стоимости

## 6. WebSocket события

### 6.1 От клиента к серверу
- Присоединение к бою
- Отправка действий в бою
- Начало/отмена поиска противника

### 6.2 От сервера к клиенту
- Начало раунда
- Результаты раунда
- Конец боя с наградами
- Найден противник
- Таймаут действий

## 7. Фоновые задачи (Queue)

### 7.1 Регулярные задачи
- Восстановление стамины (каждые 6 минут)
- Обновление таблицы лидеров
- Очистка старых данных

### 7.2 Отложенные задачи
- Уведомления через Telegram Bot
- Расчет наград после боя
- Логирование статистики

## 8. Интеграция с Telegram

### 8.1 Telegram Web App
- Валидация initData
- Получение данных пользователя
- Проверка подписи

### 8.2 Telegram Bot
- Отправка уведомлений
- Команды бота (/start, /stats)
- Inline кнопки для быстрого входа

## 9. Безопасность

### 9.1 Аутентификация
- JWT токены с коротким временем жизни
- Refresh токены
- Валидация Telegram данных

### 9.2 Защита от читов
- Все расчеты на сервере
- Валидация всех действий
- Rate limiting
- Логирование подозрительной активности

### 9.3 Защита API
- CORS настройки
- Helmet для заголовков безопасности
- Лимиты на размер запросов

## 10. Мониторинг и логирование

### 10.1 Метрики
- Количество активных пользователей
- Количество боев
- Время ответа API
- Использование ресурсов

### 10.2 Логи
- Все ошибки
- Важные игровые события
- Подозрительная активность
- Транзакции валюты

### 10.3 Алерты
- Критические ошибки
- Превышение лимитов
- Недоступность сервисов

## 11. Оптимизация

### 11.1 База данных
- Индексы на часто используемые поля
- Материализованные представления для лидерборда
- Партиционирование больших таблиц (в будущем)

### 11.2 Кэширование
- Redis для горячих данных
- CDN для статики (в будущем)

### 11.3 Производительность
- Connection pooling
- Batch операции где возможно
- Асинхронная обработка тяжелых задач

## 12. Развертывание

### 12.1 Окружения
- Development (локальное)
- Staging (тестовое)
- Production (боевое)

### 12.2 CI/CD
- Автоматические тесты
- Сборка Docker образов
- Деплой через GitHub Actions

### 12.3 Масштабирование
- Горизонтальное масштабирование API
- Read replicas для БД (в будущем)
- Load balancing
