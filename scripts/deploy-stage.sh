#!/bin/bash
# ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ stage Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: ./scripts/deploy-stage.sh

set -e

STAGE_SERVER="178.72.152.120"
STAGE_USER="root"
PROJECT_DIR="/var/www/app"
DOMAIN="stage.nightfall-arena.ru"
REPO_URL="https://github.com/AlexandrGusew/Elbrus-Arena.git"
BRANCH="dpl"

echo "ðŸš€ Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ stage Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð½Ð° $STAGE_SERVER"
echo "ðŸŒ Ð”Ð¾Ð¼ÐµÐ½: $DOMAIN"
echo ""

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´ Ð½Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ð¾Ð¼ ÑÐµÑ€Ð²ÐµÑ€Ðµ
remote_exec() {
    ssh "$STAGE_USER@$STAGE_SERVER" "$1"
}

# Ð¨Ð°Ð³ 1: ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
echo "ðŸ“¥ ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
if remote_exec "[ -d $PROJECT_DIR/.git ]"; then
    echo "âš ï¸  ÐŸÑ€Ð¾ÐµÐºÑ‚ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚, Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼..."
    remote_exec "cd $PROJECT_DIR && git fetch origin && git checkout $BRANCH && git pull origin $BRANCH"
else
    remote_exec "cd $(dirname $PROJECT_DIR) && git clone $REPO_URL $(basename $PROJECT_DIR) && cd $PROJECT_DIR && git checkout $BRANCH"
fi

# Ð¨Ð°Ð³ 2: ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¹ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ prod-configs)
echo "ðŸ“‹ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¹..."
if [ -d "./prod-configs" ]; then
    echo "ðŸ“¤ ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
    if [ -f "./prod-configs/.env.backend" ]; then
        scp "./prod-configs/.env.backend" "$STAGE_USER@$STAGE_SERVER:$PROJECT_DIR/backend/.env"
    fi
    if [ -f "./prod-configs/.env.root" ]; then
        scp "./prod-configs/.env.root" "$STAGE_USER@$STAGE_SERVER:$PROJECT_DIR/.env"
    fi
else
    echo "âš ï¸  Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ prod-configs Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°. Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ .env Ñ„Ð°Ð¹Ð»Ñ‹ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ."
fi

# Ð¨Ð°Ð³ 3: ÐÐ´Ð°Ð¿Ñ‚Ð°Ñ†Ð¸Ñ .env Ð´Ð»Ñ stage
echo "ðŸ”§ ÐÐ´Ð°Ð¿Ñ‚Ð°Ñ†Ð¸Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ stage..."
remote_exec "cd $PROJECT_DIR && \
    sed -i 's|FRONTEND_URL=.*|FRONTEND_URL=https://$DOMAIN|g' .env backend/.env 2>/dev/null || true && \
    sed -i 's|CORS_ORIGINS=.*|CORS_ORIGINS=https://nightfall-arena.ru,https://$DOMAIN|g' .env backend/.env 2>/dev/null || true"

# Ð¨Ð°Ð³ 4: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
echo "ðŸŒ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Nginx..."
cat > /tmp/nginx-stage.conf <<EOF
# HTTP server - redirect to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name $DOMAIN;

    # Let's Encrypt verification
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }

    # Redirect all other HTTP traffic to HTTPS
    location / {
        return 301 https://\$server_name\$request_uri;
    }
}

# HTTPS server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name $DOMAIN;

    # SSL certificates (will be set by certbot)
    ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;

    # SSL optimization
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # MinIO proxy Ð´Ð»Ñ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð¼ÐµÐ´Ð¸Ð° (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ MinIO)
    location /minio/ {
        proxy_pass http://nightfall-arena.ru/minio/;
        proxy_set_header Host nightfall-arena.ru;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;

        # CORS headers Ð´Ð»Ñ Ð¼ÐµÐ´Ð¸Ð°-Ñ„Ð°Ð¹Ð»Ð¾Ð²
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Range, Content-Type' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range' always;

        # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° preflight Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
        if (\$request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Range, Content-Type';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }

        # ÐšÐµÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¼ÐµÐ´Ð¸Ð°-Ñ„Ð°Ð¹Ð»Ð¾Ð²
        expires 30d;
        add_header Cache-Control "public, immutable";

        # ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° range requests Ð´Ð»Ñ Ð²Ð¸Ð´ÐµÐ¾
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # Backend API
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;

        # Ð¢Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ñ‹ Ð´Ð»Ñ API
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # WebSocket Ð´Ð»Ñ real-time communication
    location /socket.io {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;

        # WebSocket Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ñ‹
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }

    # Frontend SPA
    location / {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;

        # ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° SPA routing
        proxy_intercept_errors on;
        error_page 404 = @frontend;
    }

    # Fallback Ð´Ð»Ñ SPA (Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ index.html Ð´Ð»Ñ Ð²ÑÐµÑ… 404)
    location @frontend {
        proxy_pass http://localhost:8080;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    # Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
    access_log /var/log/nginx/stage-nightfall-arena-access.log;
    error_log /var/log/nginx/stage-nightfall-arena-error.log;
}
EOF

scp /tmp/nginx-stage.conf "$STAGE_USER@$STAGE_SERVER:/etc/nginx/sites-available/$DOMAIN"
remote_exec "ln -sf /etc/nginx/sites-available/$DOMAIN /etc/nginx/sites-enabled/$DOMAIN && nginx -t"

# Ð¨Ð°Ð³ 5: ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°
echo "ðŸ”’ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°..."
remote_exec "certbot --nginx -d $DOMAIN --non-interactive --agree-tos --email admin@nightfall-arena.ru || echo 'Certbot Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ñ€ÑƒÑ‡Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ð¾ÑÐ»Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ DNS'"

# Ð¨Ð°Ð³ 6: Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
echo "ðŸ—„ï¸  Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
remote_exec "cd $PROJECT_DIR && docker compose run --rm backend npx prisma migrate deploy"

# Ð¨Ð°Ð³ 7: Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº
echo "ðŸ”¨ Ð¡Ð±Ð¾Ñ€ÐºÐ° Docker Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²..."
remote_exec "cd $PROJECT_DIR && docker compose build --no-cache"

echo "â–¶ï¸  Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
remote_exec "cd $PROJECT_DIR && docker compose up -d"

echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
sleep 15

# Ð¨Ð°Ð³ 8: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
echo "âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°..."
remote_exec "cd $PROJECT_DIR && docker compose ps"

echo ""
echo "âœ¨ Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!"
echo "ðŸŒ Stage Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: https://$DOMAIN"
echo ""
echo "ðŸ“‹ ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
echo "   ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð»Ð¾Ð³Ð¾Ð²: ssh $STAGE_USER@$STAGE_SERVER 'cd $PROJECT_DIR && docker compose logs -f'"
echo "   ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº: ssh $STAGE_USER@$STAGE_SERVER 'cd $PROJECT_DIR && docker compose restart'"
echo "   Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: ssh $STAGE_USER@$STAGE_SERVER 'cd $PROJECT_DIR && docker compose ps'"

